import os
import json
import httpx # ë¹„ë™ê¸° HTTP í†µì‹ ì„ ìœ„í•´ ì¶”ì²œ
from langchain_core.prompts import ChatPromptTemplate
from dotenv import load_dotenv

load_dotenv()

async def call_gemini_api(prompt_text):
    """Gemini APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê³µí†µ í•¨ìˆ˜"""
    gms_key = os.getenv("GMS_KEY")
    url = os.getenv("GMS_URL")

    headers = {"Content-Type": "application/json", "x-goog-api-key": gms_key}
    payload = {
        "contents": [{"parts": [{"text": prompt_text}]}],
        "generationConfig": {"temperature": 0.1, "maxOutputTokens": 3000}
    }

    # httpxë¥¼ ì‚¬ìš©í•˜ì—¬ Non-blockingìœ¼ë¡œ API í˜¸ì¶œ
    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            response = await client.post(url, headers=headers, json=payload)
            response.raise_for_status() # 200ë²ˆëŒ€ ì‘ë‹µì´ ì•„ë‹ˆë©´ ì˜ˆì™¸ ë°œìƒ
            result = response.json()
            # API ì‘ë‹µ êµ¬ì¡°ì— 'candidates'ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ ì¥ì¹˜
            if 'candidates' in result and result['candidates']:
                return result['candidates'][0]['content']['parts'][0]['text'].strip()
            return "API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        except httpx.HTTPStatusError as e:
            return f"ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ìƒíƒœ ì½”ë“œ: {e.response.status_code})"
        except Exception as e:
            return f"ë‹µë³€ ìƒì„± ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

    # 2. ê²°ê³¼ íŒŒì‹± ë¡œì§: ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ íŒë‹¨ (ê°€ì¥ ì•ˆì „í•¨)

def expand_context(best_id, collection):
    """IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•ë’¤ 2ê°œì”© ì´ 5ê°œì˜ ì²­í¬ë¥¼ ê°€ì ¸ì™€ ë¬¸ë§¥ì„ ì™„ì„±í•©ë‹ˆë‹¤."""
    parts = best_id.rsplit('_', 1)
    id_prefix = parts[0]
    current_idx = int(parts[1])

    # ê°€ì ¸ì˜¬ ì²­í¬ ID ë²”ìœ„ë¥¼ ê³„ì‚° (ì¸ë±ìŠ¤ê°€ 1 ë¯¸ë§Œì´ ë˜ì§€ ì•Šë„ë¡ ë°©ì§€)
    start_idx = max(1, current_idx - 2)
    end_idx = current_idx + 2

    window_ids = [f"{id_prefix}_{i}" for i in range(start_idx, end_idx + 1)]

    retrieved_data = collection.get(ids=window_ids, include=['documents'])

    # ìˆœì„œë¥¼ ë³´ì¥í•˜ë©° ë¬¸ì„œë¥¼ ê²°í•©
    documents_dict = {doc_id: doc_text for doc_id, doc_text in zip(retrieved_data['ids'], retrieved_data['documents'])}
    sorted_documents = [documents_dict[doc_id] for doc_id in window_ids if doc_id in documents_dict]

    return "\n\n".join(sorted_documents)

async def get_rag_answer(user_question: str, collection, title: str):
    """RAG íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•©ë‹ˆë‹¤."""

    # 1. ìœ ì‚¬ë„ ê²€ìƒ‰ (ê°€ì¥ ê´€ë ¨ ìˆëŠ” 1ê°œ ì²­í¬ í™•ë³´)
    if collection is None:
        return "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

    where_clause = {"title": title}
    results = collection.query(
        query_texts=[user_question],
        n_results=1,
        where=where_clause,
        include=["documents", "metadatas", "distances"]
    )
    is_relevant_result = False
    if results and results['ids'] and results['ids'][0]:
        # ê²°ê³¼ê°€ ìˆì„ ê²½ìš°, ìœ ì‚¬ë„ ì„ê³„ê°’(Threshold) í™•ì¸
        if results['distances'][0][0] <= 0.6:
            is_relevant_result = True

    # 2. ê²€ìƒ‰ ê²°ê³¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ë¶„ê¸°
    if not is_relevant_result:
        # 2-1. ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ê´€ë ¨ì„±ì´ ë‚®ì„ ê²½ìš°: ì¼ë°˜ì ì¸ ë‹µë³€ ìƒì„±
        general_prompt_template = ChatPromptTemplate.from_messages([
            ("system", (
                "ë‹¹ì‹ ì€ ì„œìš¸ì‹œ ì£¼ê±° ì§€ì› ì„œë¹„ìŠ¤ 'ì„œìš¸ì§‘ì‚¬'ì˜ AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. "
                "ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§€ëŠ” ì£¼ì œ({title})ëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\n"
                "1. íŠ¹ì • ì£¼ê±° [ê³µê³ ]\n"
                "2. ì •ë¶€ë‚˜ ì‹œì˜ ì£¼ê±° [ì •ì±…]\n"
                "3. ë¶€ë™ì‚°/ê±´ì¶• ê´€ë ¨ ì „ë¬¸ [ìš©ì–´/í‚¤ì›Œë“œ]\n\n"
                "ë‹¹ì‹ ì€ ì£¼ì œ({title})ì˜ ì´ë¦„ì„ ë³´ê³  ì–´ë–¤ ì¹´í…Œê³ ë¦¬ì¸ì§€ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•œ ë’¤, ì „ë‹¬ëœ ì§ˆë¬¸ì— ëŒ€í•´ 'ì£¼ê±° ë§¥ë½'ì—ì„œ ê°€ì¥ ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. "
                "ë§Œì•½ [{title}]ì´ ì „ë¬¸ ìš©ì–´ë¼ë©´ ê·¸ ì •ì˜ì™€ ì£¼ê±° ìƒí™œì—ì„œì˜ ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ê³ , ê³µê³ ë‚˜ ì •ì±…ì´ë¼ë©´ ì¼ë°˜ì ì¸ ì ˆì°¨ë‚˜ í˜œíƒì„ ì•ˆë‚´í•˜ì„¸ìš”.\n\n"
                "ex) [question]ì€ [title]ì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤ -> ì²˜ëŸ¼ ê²€ì¦ê³¼ì •ì€ êµ³ì´ ì‚¬ìš©ìì—ì„œ ì„¤ëª… í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€ë‹µë§Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤."

                "ëª¨ë“  ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì‚¬ìš©ì„ í•´ì•¼í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ ê°•ì¡°í•˜ê±°ë‚˜ ì´ëª¨í‹°ì½˜ì„ ë„£ì–´ ê°€ë…ì„±ì„ ê¼­ ì¢‹ê²Œ ë‹µë³€ì„ ë§Œë“œì„¸ìš”. "
                "ì •ë³´ì˜ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                "1. ì£¼ìš” ì„¹ì…˜ ì œëª©ì€ '### ğŸ“… ì œëª©' ì²˜ëŸ¼ í—¤ë”(#)ì™€ ì´ëª¨ì§€ë¥¼ ì¡°í•©í•´ì„œ ì‘ì„±í•˜ì„¸ìš”.\n"
                "2. í•µì‹¬ ìˆ˜ì¹˜ë‚˜ ë‚ ì§œëŠ” **ê°•ì¡°(Bold)** ì²˜ë¦¬í•˜ì„¸ìš”.\n"
                "3. ë‚˜ì—´í•  ì •ë³´ê°€ ìˆë‹¤ë©´ ìˆ«ìë‚˜ ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë¶„í•˜ì„¸ìš”.\n"
                
                "ë‹µë³€ì€ ì§§ì•„ë„ ë˜ì§€ë§Œ ê¸¸ë©´ ìµœëŒ€ 10ë¬¸ì¥ê¹Œì§€ ì••ì¶•í•´ì„œ ê°€ë…ì„± ì‰½ê²Œ ë§ì„ ë§Œë“œì„¸ìš”"
                " ì£¼ì–´ì§„ 'ë‚´ìš©'ì— ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì´ ì—†ë‹¤ë©´, 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì œê³µëœ ê³µê³ ë¬¸ ì•ˆì—ì„œëŠ” í•´ë‹¹ ë‚´ìš©ì„ ì°¾ê¸° ì–´ë µë„¤ìš”. ğŸ˜… í˜¹ì‹œ ë‹¤ë¥¸ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”?' ì´ ë¬¸ì¥ì€ ë‹µë³€ ë§¨ ë§ˆì§€ë§‰ìœ¼ë¡œ ê³ ì •.\n\n"
            )),
            ("human", "ì£¼ì œ: {title}\nì§ˆë¬¸: {question}\n\nì„œìš¸ì§‘ì‚¬ì˜ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ì£¼ì œì™€ ì§ˆë¬¸ì— ëŒ€í•´ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì¤˜.")
        ])
        full_prompt = general_prompt_template.format(question=user_question, title=title)
        return await call_gemini_api(full_prompt)
    else:
        # 2-2. ê²€ìƒ‰ ê²°ê³¼ê°€ ìœ íš¨í•  ê²½ìš°: RAG ë‹µë³€ ìƒì„±
        # 3. ë¬¸ë§¥ í™•ì¥ (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë°©ì‹ìœ¼ë¡œ ì£¼ë³€ í…ìŠ¤íŠ¸ ë³‘í•©)
        best_id = results['ids'][0][0]
        final_context = expand_context(best_id, collection)

        # 4. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ì‹œìŠ¤í…œ ì—­í• ì„ í†µí•œ ì „ë¬¸ê°€ í˜ë¥´ì†Œë‚˜ ë¶€ì—¬)
        prompt_template = ChatPromptTemplate.from_messages([
            ("system", (
                "ë‹¹ì‹ ì€ ì„œìš¸ì‹œ ì£¼ê±° ì§€ì› ì„œë¹„ìŠ¤ 'ì„œìš¸ì§‘ì‚¬'ì˜ AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. "
                "ë‹¹ì‹ ì—ê²Œ ì£¼ì–´ì§€ëŠ” ì£¼ì œ({title})ëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.\n"
                "1. íŠ¹ì • ì£¼ê±° [ê³µê³ ]\n"
                "2. ì •ë¶€ë‚˜ ì‹œì˜ ì£¼ê±° [ì •ì±…]\n"
                "3. ë¶€ë™ì‚°/ê±´ì¶• ê´€ë ¨ ì „ë¬¸ [ìš©ì–´/í‚¤ì›Œë“œ]\n\n"
                "ë‹¹ì‹ ì€ ì£¼ì œ({title})ì˜ ì´ë¦„ì„ ë³´ê³  ì–´ë–¤ ì¹´í…Œê³ ë¦¬ì¸ì§€ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•œ ë’¤, ì „ë‹¬ëœ ì§ˆë¬¸ì— ëŒ€í•´ 'ì£¼ê±° ë§¥ë½'ì—ì„œ ê°€ì¥ ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. "
                "ë§Œì•½ [{title}]ì´ ì „ë¬¸ ìš©ì–´ë¼ë©´ ê·¸ ì •ì˜ì™€ ì£¼ê±° ìƒí™œì—ì„œì˜ ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ê³ , ê³µê³ ë‚˜ ì •ì±…ì´ë¼ë©´ ì¼ë°˜ì ì¸ ì ˆì°¨ë‚˜ í˜œíƒì„ ì•ˆë‚´í•˜ì„¸ìš”.\n\n"
                "ex) [question]ì€ [title]ì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤ -> ì²˜ëŸ¼ ê²€ì¦ê³¼ì •ì€ êµ³ì´ ì‚¬ìš©ìì—ì„œ ì„¤ëª… í•  í•„ìš” ì—†ìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€ë‹µë§Œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤."
                "ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì˜¤ì§ ì£¼ì–´ì§„ 'ë‚´ìš©'({source_folder} ê³µê³ )ì— ëŒ€í•´ì„œë§Œ ì‚¬ì‹¤ì— ê¸°ë°˜í•˜ì—¬ ì •í™•í•˜ê²Œ ë‹µë³€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. "
                "ì ˆëŒ€ë¡œ 'ë‚´ìš©'ì— ì—†ëŠ” ì •ë³´ë‚˜ ë‹¹ì‹ ì˜ ì™¸ë¶€ ì§€ì‹ì„ ì‚¬ìš©í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. "
                "ë‹µë³€ì€ ì¹œì ˆí•œ ì „ë¬¸ê°€ì˜ ë§íˆ¬ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. "
                
                
                "ëª¨ë“  ë‹µë³€ì€ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì‚¬ìš©ì„ í•´ì•¼í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ ê°•ì¡°í•˜ê±°ë‚˜ ì´ëª¨í‹°ì½˜ì„ ë„£ì–´ ê°€ë…ì„±ì„ ê¼­ ì¢‹ê²Œ ë‹µë³€ì„ ë§Œë“œì„¸ìš”. "
                "ì •ë³´ì˜ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.\n"
                "1. ì£¼ìš” ì„¹ì…˜ ì œëª©ì€ '### ğŸ“… ì œëª©' ì²˜ëŸ¼ í—¤ë”(#)ì™€ ì´ëª¨ì§€ë¥¼ ì¡°í•©í•´ì„œ ì‘ì„±í•˜ì„¸ìš”.\n"
                "2. í•µì‹¬ ìˆ˜ì¹˜ë‚˜ ë‚ ì§œëŠ” **ê°•ì¡°(Bold)** ì²˜ë¦¬í•˜ì„¸ìš”.\n"
                "3. ë‚˜ì—´í•  ì •ë³´ê°€ ìˆë‹¤ë©´ ìˆ«ìë‚˜ ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ë¶„í•˜ì„¸ìš”.\n"
                
                
                "ì±—ë´‡ í˜•íƒœì´ê¸° ë•Œë¬¸ì— ì§§ìœ¼ë©´ í•œë¬¸ì¥, ê¸¸ë©´10ë¬¸ì¥ ì´ë‚´ë¡œ ì••ì¶•í•´ì„œ í•µì‹¬ì ì´ê³  ê°€ë…ì„± ì‰½ê²Œ ë§Œë“¤ì–´ì£¼ì„¸ìš”"
            )),
            ("human", "ë‚´ìš©:\n{context}\n\nì§ˆë¬¸: {question}")
        ])
        full_prompt = prompt_template.format(context=final_context, question=user_question, title=title, source_folder=title)

        # 5. Gemini API í˜¸ì¶œ (ë¹„ë™ê¸° ì²˜ë¦¬)
        return await call_gemini_api(full_prompt)